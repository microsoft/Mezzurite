!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.MezzuriteCore={})}(this,function(e){"use strict";var t={captureCycleTimeout:1e4,slowestResourceTimeout:4e3,idLength:6,domAttributeName:"perf-id",measureNamePrefix:"mz",altName:"ALT",vltName:"VLT",vltMarkStart:"VltStart",altMarkStart:"AltStart",altMarkEnd:"AltEnd",componentMarkStart:"ComponentStart",componentMarkEnd:"ComponentEnd",componentMarkRenderStart:"ComponentRenderStart",jsllConfigName:"jsll",versionName:"MezzuriteVersion",allComponents:"AllComponents",redirect:"Redirect",sessionData:"MezzuriteSession",fullNamePartTitle:"title",fullNamePartKey:"key",unsupportedBrowserName:"unsupportedBrowser",unsupportedBrowserPerf:"This was sent from a client using a browser that does not support the Performance API"},r=function(){function e(){this.firstViewLoaded=!1,this.captureCycleStarted=!1,this.routerPerf=!1,this.measures=[],this.defaultLogs=[],this.childElementNames={},this.slowestResource={},this.currentComponents={},this.vltComponentLookup={}}return e}(),n=function(){function e(){}return e.createMezzuriteObject=function(e){var t=new r;for(var n in t)e[n]=t[n]},e.testReset=function(){var e=window.mezzurite;e.childElementNames={},e.slowestResource={},e.currentComponents={},e.vltComponentLookup={},window.mezzurite=e},e.makeId=function(){for(var e="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<t.idLength;n++)e+=r.charAt(Math.floor(Math.random()*r.length));return e},e.getFunctionName=function(e){var t=e.toString();return t=t.substr("function ".length),t=t.substr(0,t.indexOf("("))},e.getDisplayName=function(t){return void 0!==t.name?t.name:e.getFunctionName(t)},e.getName=function(e,r,n){return void 0===n&&(n=null),null===n?t.measureNamePrefix+";"+e+";"+r:t.measureNamePrefix+";"+e+";"+r+";"+n},e.createMetric=function(e,t,r){void 0===r&&(r=null);var n={metricType:e,value:t};return null!==r&&(n.data=JSON.stringify(r)),n},e.walkDOM=function(t,r,n){for(n(t,r),t=t.firstChild;t;)e.walkDOM(t,r,n),t=t.nextSibling},e.getFullNamePart=function(e,r){var n=e.split(";");switch(r){case t.fullNamePartTitle:return n[1];case t.fullNamePartKey:return n[2];default:return null}},e}(),i=function(){function e(){}return e.measure=function(e,r,i){void 0===r&&(r=null),void 0===i&&(i=null);var o,a,u=n.getFullNamePart(e,t.fullNamePartTitle),m=n.getFullNamePart(e,t.fullNamePartKey);if(void 0===e)return null;u===t.altName?a=performance.getEntriesByName(t.altMarkEnd)[0]:u===t.vltName?(o=performance.getEntriesByName(t.vltMarkStart)[0],a={startTime:i}):(o=performance.getEntriesByName(m+t.componentMarkStart)[0],a=performance.getEntriesByName(m+t.componentMarkEnd)[0]);var l=performance.getEntriesByName(m+t.componentMarkRenderStart)[0],s=void 0!==o?o.startTime:0,c=a.startTime;null!==r&&r.responseEnd>c&&(c=r.responseEnd);var d={name:e,startTime:s,endTime:c,timeToMount:a.startTime-s,componentLoadTime:c-s};r&&r.responseEnd>=s?d.slowestResourceEnd=r.responseEnd:null!==r&&(d.slowestResourceEnd=-1),u!==t.altName&&u!==t.vltName&&l&&(d.renderStartTime=l.startTime),window.mezzurite.measures.push(d)},e.getMeasureByName=function(e){if(void 0===e||null===e)return null;for(var t=window.mezzurite.measures,r=0;r<t.length;r++)if(e===t[r].name)return t[r];return null},e.getCurrentComponents=function(){return window.mezzurite.measures.filter(function(e){return-1===e.name.indexOf(t.measureNamePrefix+";"+t.altName)&&-1===e.name.indexOf(t.measureNamePrefix+";"+t.vltName)&&e.startTime>=window.mezzurite.startTime&&e.startTime<=window.mezzurite.endTime})},e.getCurrentComponentsLookup=function(){for(var e=window.mezzurite.measures.filter(function(e){return-1===e.name.indexOf(t.measureNamePrefix+";"+t.altName)&&-1===e.name.indexOf(t.measureNamePrefix+";"+t.vltName)&&e.startTime>=window.mezzurite.startTime&&e.startTime<=window.mezzurite.endTime}),r={},n=0;n<e.length;n++)r[e[n].name]=e[n];return r},e.calculateVlt=function(){var e,r=null,i=[],o=this.getCurrentComponentsLookup(),a=window.mezzurite.vltComponentLookup;for(var u in a)if(!0===a[u])if(i.push(o[u]),null!==r){var m=window.mezzurite.slowestResource[u];void 0!==m&&null!==m&&m.responseEnd;var l=r.componentLoadTime+r.startTime;o[u].componentLoadTime+o[u].startTime>l&&(r=o[u])}else r=o[u];if(null===r)return null;var u=n.getFullNamePart(r.name,t.fullNamePartKey),s=t.measureNamePrefix+";"+t.vltName+";"+u;return this.measure(s,null,r.endTime),e=this.getMeasureByName(s),performance.clearMarks(t.vltMarkStart),{vlt:e.componentLoadTime,components:i}},e.getElNames=function(e,t){void 0===window.mezzurite.childElementNames[t]&&(window.mezzurite.childElementNames[t]=[]),"IMG"===e.tagName&&window.mezzurite.childElementNames[t].push(e.src)},e.calculateSlowestResource=function(e,r){var i=n.getFullNamePart(r,t.fullNamePartKey),o=null;n.walkDOM(e,i,this.getElNames);var a=performance.getEntriesByType("resource").filter(function(e){return"img"===e.initiatorType}),u=window.mezzurite.childElementNames[i];if(0!==a.length){for(var m=0;m<u.length;m++)for(var l=0;l<a.length;l++)u[m]===a[l].name&&(null===o||a[l].responseEnd>o.responseEnd)&&(o=a[l]);return window.mezzurite.slowestResource[r]=o,o}},e}(),o=function(){function e(){}return e.startCaptureCycle=function(){var e=this;window.mezzurite.captureCycleStarted||(window.mezzurite.startTime=window.performance.now(),window.mezzurite.captureCycleStarted=!0,window.mezzurite.captureTimer=setTimeout(function(){e.captureTimings()},t.captureCycleTimeout))},e.captureTimings=function(e){void 0===e&&(e=!1),clearTimeout(window.mezzurite.captureTimer),window.mezzurite.endTime=window.performance.now(),window.mezzurite.captureCycleStarted||(window.mezzurite.captureCycleStarted=!0),this.submitTelemetry(e),window.mezzurite.captureCycleStarted=!1},e.submitTelemetry=function(e){var r=[];r.push(n.createMetric(t.redirect,!1===e?0:1));var o=i.getCurrentComponents();if(window.mezzurite.routerPerf){if(!1===window.mezzurite.firstViewLoaded){var a=window.mezzurite.measures.filter(function(e){return e.name.indexOf(t.altName)>-1})[0];r.push(n.createMetric(t.altName,a.componentLoadTime)),window.mezzurite.firstViewLoaded=!0}if(o.length>0){var u=i.calculateVlt();r.push(n.createMetric(t.vltName,u.vlt,u.components)),r.push(n.createMetric(t.allComponents,-1,o))}}this.log(r),n.testReset()},e.log=function(e){if(window.mezzurite)if(e.length>1){var t={Timings:e,Framework:{name:window.mezzurite.packageName,version:window.mezzurite.packageVersion},ViewportWidth:window.mezzurite.viewportWidth,ViewportHeight:window.mezzurite.viewportHeight};window.location.href.indexOf("localhost")>-1&&console.log("to log for testing: ",t),window.mezzurite.EventElement&&window.mezzurite.EventElement.dispatchEvent(new CustomEvent("Timing",{detail:t}))}else console.log("nothing for Mezzurite to log.")},e.compatibilityCheck=function(){var e=void 0!==window.performance;if(!e){var r=[n.createMetric(t.unsupportedBrowserName,-1,t.unsupportedBrowserPerf)];this.log(r)}return e},e}(),a=function(){function e(){}return e}();e.PerformanceTelemetryService=o,e.PerformanceTimingService=i,e.PerfMetric=a,e.MezzuriteConstants=t,e.MezzuriteUtils=n,Object.defineProperty(e,"__esModule",{value:!0})});
